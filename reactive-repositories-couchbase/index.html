<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>
        
        Reactive Repositories with Couchbase &middot; Alex's Derkach Blog
        
    </title>
    <meta name="keywords" content="rxjava java8 couchbase reactive">

    <!-- CSS -->
    <link rel="stylesheet" href="http://alexsderkach.io/assets/main.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700">
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="http://alexsderkach.io/assets/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="http://alexsderkach.io/assets/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://alexsderkach.io/assets/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="http://alexsderkach.io/assets/favicons/manifest.json">
    <link rel="mask-icon" href="http://alexsderkach.io/assets/favicons/safari-pinned-tab.svg" color="#000000">
    <meta name="theme-color" content="#ffffff">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="Alex&#39;s Derkach Blog" href="http://alexsderkach.io/feed.xml">

    <!-- Begin Jekyll SEO tag v2.2.3 -->
<meta property="og:title" content="Reactive Repositories with Couchbase" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My experiences and thoughts" />
<meta property="og:description" content="My experiences and thoughts" />
<link rel="canonical" href="http://alexsderkach.io/reactive-repositories-couchbase/" />
<meta property="og:url" content="http://alexsderkach.io/reactive-repositories-couchbase/" />
<meta property="og:site_name" content="Alexâ€™s Derkach Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-05-16T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@alexsderkach" />
<meta name="twitter:creator" content="@alexsderkach" />
<script type="application/ld+json">
{"@context":"http://schema.org","@type":"BlogPosting","headline":"Reactive Repositories with Couchbase","author":{"@type":"Person","name":null},"datePublished":"2017-05-16T00:00:00+00:00","dateModified":"2017-05-16T00:00:00+00:00","description":"My experiences and thoughts","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://alexsderkach.io/assets/me.png"},"name":null},"mainEntityOfPage":{"@type":"WebPage","@id":"http://alexsderkach.io/reactive-repositories-couchbase/"},"url":"http://alexsderkach.io/reactive-repositories-couchbase/"}</script>
<!-- End Jekyll SEO tag -->

    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-94002520-1', 'auto');
  ga('send', 'pageview');

</script>
  

    
</head>
<body>
    <header class="padded">
    <h3 class="title">
        <a href="http://alexsderkach.io/" title="Home">@alexsderkach</a>
    </h3>
    <ul class="nav">
        <li><a href="https://github.com/alexsderkach?tab=repositories" target="_blank">Projects</a></li>
        <li><a href="http://alexsderkach.io/talks">Talks</a></li>
        <li><a href="http://alexsderkach.io/me">Me</a></li>
        <li><a href="https://twitter.com/alexsderkach" target="_blank">ðŸ’¬</a></li>
    </ul>
</header>
    <div class="body">

    <article>
        <h1 class="padded">Reactive Repositories with Couchbase</h1>
        <span class="meta padded">
            May 16, 2017 &middot;
            

11 mins
 read &middot;
            <a href="http://alexsderkach.io/reactive-repositories-couchbase/#disqus_thread" itemprop="discussionUrl">0 Comments</a>
        </span>
        <main>
<figure class="image">
    
    
    <img async="" src="http://alexsderkach.io/assets/posts/2017-05-16-reactive-repositories-with-couchbase/couchbase-logo.png" alt="Couchbase + RxJava" />
</figure>

<h2 id="blocking-vs-non-blocking">Blocking vs Non-blocking</h2>
<p>Every call to third-party resource by its nature is asynchronous.
Your application could work in parallel, while that resource is processing the request.
But this call is usually blocking &amp; synchronous, because our applications are using thread-per-request model.
It is simpler.</p>

<blockquote>
  <p>We can convert asynchronous, non-blocking code to synchronous, blocking.</p>
</blockquote>

<p>The problem raises, when your application is using event loop to process requests.
What if, it becomes necessary to use some library which provides a exclusively blocking API?</p>

<blockquote>
  <p>There is no way to convert blocking code to non-blocking.</p>
</blockquote>

<p>If you need to use blocking API, while your whole application is implemented using non-blocking approach, the solution is <strong>allocate-thread-per-call-to-blocking-resource</strong>.
But, if youâ€™re going to use this library often, you will face the same performance issues, which are placed by thread-per-request model.</p>

<p>Today, modern application are implemented using non-blocking approach, because thereâ€™s too much communication with third-party resources, e.g. microservices.
Thus, the only, sane way to design an API is to make it non-blocking &amp; asynchronous.
It provides better performance and scalability. Eventually, we can convert non-blocking to blocking, for apps that use synchronous approach.</p>

<h2 id="couchbase-in-game-development">Couchbase in Game Development</h2>
<p><strong>Couchbase</strong> - the most common choice if you are going to build a video-game.
Each player has <strong>unique</strong> story. It perfectly fits in <strong>Key-Document</strong> model.
Games are mostly interactive. To be interactive, application must be responsive, must respond in timely manner.</p>

<p>Couchbase SDK is build using RxJava 1 &amp; Ring Buffer, thus making <em>DB &lt;-&gt; Server</em> communication as fast as possible.</p>

<p>Could it be better?</p>
<ul>
  <li>By performance - arguably</li>
  <li>By usability - yes</li>
</ul>

<p>All operations with data in this SDK are done via <strong>Document</strong> objects.
Every time we need to make any CRUD operation, we need to convert <strong>DTO</strong> to <strong>Document</strong>.
When you have variety of DTOs, and you need to perform the same set of operations with them, a common pattern arises.</p>

<blockquote>
  <p>Use a repository to separate the logic that retrieves the data and maps it to the entity model from the business logic that acts on the model.</p>
</blockquote>

<p>The most common operations, which are used in Couchbase Repository, are the following:</p>
<ol>
  <li>get</li>
  <li>insert</li>
  <li>remove</li>
  <li>update</li>
  <li>cas (insert or update)</li>
</ol>

<p>Get implementation is simple. CAS operation is the tricky one. Others follow common logic.</p>

<h2 id="building-reactive-repository-layer">Building Reactive Repository Layer</h2>

<p>First of all we need serialization/deserialization layer.
Couchbase provides an implementation of <strong>Document</strong> which contains JSON data in raw format - <strong>RawJsonDocument</strong>. 
It allows us to use Jackson, to convert DTO to String, and eventually to <strong>RawJsonDocument</strong>.</p>

<p>Converter will look like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></td><td class="code"><pre><span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Converter</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ObjectMapper</span> <span class="n">OBJECT_MAPPER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">keyCreator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">expiry</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">V</span> <span class="nf">from</span><span class="o">(</span><span class="n">RawJsonDocument</span> <span class="n">document</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">deserialize</span><span class="o">(</span><span class="n">document</span><span class="o">.</span><span class="na">content</span><span class="o">(),</span> <span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">RawJsonDocument</span> <span class="nf">document</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">RawJsonDocument</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">keyCreator</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">RawJsonDocument</span> <span class="nf">document</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">document</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span> <span class="c1">// new documents have cas = 0</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">RawJsonDocument</span> <span class="nf">document</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">,</span> <span class="kt">long</span> <span class="n">cas</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">requireNonNull</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">"Key can't be null"</span><span class="o">);</span>
        <span class="n">requireNonNull</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="s">"Value can't be null"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">RawJsonDocument</span>
            <span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">keyCreator</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">expiry</span><span class="o">,</span> <span class="n">serialize</span><span class="o">(</span><span class="n">value</span><span class="o">),</span> <span class="n">cas</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@SneakyThrows</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">serialize</span><span class="o">(</span><span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">OBJECT_MAPPER</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@SneakyThrows</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">V</span> <span class="nf">deserialize</span><span class="o">(</span><span class="n">String</span> <span class="n">content</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">OBJECT_MAPPER</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Then, lets define the template of repository.
Couchbase provides its API via AsyncBucket, which is based on RxJava 1.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CouchbaseRepository</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AsyncBucket</span> <span class="n">bucket</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">converter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxRetry</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">timeout</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">insert</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Completable</span> <span class="nf">remove</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">update</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">V</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">updateFunction</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">cas</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">updateFunction</span><span class="o">)</span> <span class="o">{</span> <span class="o">..</span> <span class="o">}</span>

<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Now, lets implement operations.</p>

<h3 id="1-getk-key">1. get(K key)</h3>
<p>Contract is the following:</p>
<ul>
  <li>If document exists, return it.</li>
  <li>If document does not exist, return empty Observable.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// get() will try to fetch RawJsonDocument, </span>
    <span class="c1">// because converter created empty document of this type</span>
    <span class="c1">// if document does not exist, get() emits 0 items</span>
    <span class="k">return</span> <span class="n">bucket</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">converter</span><span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">key</span><span class="o">))</span>
        <span class="o">.</span><span class="na">compose</span><span class="o">(</span><span class="n">common</span><span class="o">(</span><span class="n">retryFunction</span><span class="o">()));</span>         <span class="c1">// common code</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Common post processing code for observable with response looks like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="kd">private</span> <span class="n">Observable</span><span class="o">.</span><span class="na">Transformer</span><span class="o">&lt;</span><span class="n">RawJsonDocument</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="nf">common</span><span class="o">(</span><span class="n">RetryWhenFunction</span> <span class="n">retryWhenFunction</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">observable</span> <span class="o">-&gt;</span> <span class="n">observable</span>
        <span class="o">.</span><span class="na">timeout</span><span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">)</span> <span class="c1">// throw error in case of request timeout</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">converter:</span><span class="o">:</span><span class="n">from</span><span class="o">)</span>                    <span class="c1">// deserialize</span>
        <span class="o">.</span><span class="na">retryWhen</span><span class="o">(</span><span class="n">retryWhenFunction</span><span class="o">);</span>           <span class="c1">// retry in case of failure</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Retry Function looks like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="kd">private</span> <span class="n">RetryWhenFunction</span> <span class="nf">retryFunction</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">anyOf</span><span class="o">(</span><span class="n">TemporaryFailureException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">maxRetry</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="2-insertk-key-v-value">2. insert(K key, V value)</h3>
<p>Contract is the following:</p>
<ul>
  <li>If document exists, throw <strong>DocumentAlreadyExistsException</strong>.</li>
  <li>If document does not exist, return Observable with new value.</li>
</ul>

<p>Code looks almost the same:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">insert</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">bucket</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">converter</span><span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">))</span>
        <span class="o">.</span><span class="na">compose</span><span class="o">(</span><span class="n">common</span><span class="o">(</span><span class="n">retryFunction</span><span class="o">()));</span>         <span class="c1">// common code</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="3-removek-key">3. remove(K key)</h3>
<p>Contract is the following:</p>
<ul>
  <li>If document was removed, complete.</li>
  <li>If document does not exist, complete.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kd">public</span> <span class="n">Completable</span> <span class="nf">remove</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">bucket</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">converter</span><span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">key</span><span class="o">))</span>
         <span class="c1">// complete if document does not exist</span>
        <span class="o">.</span><span class="na">onErrorResumeNext</span><span class="o">(</span>
            <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span> <span class="k">instanceof</span> <span class="n">DocumentDoesNotExistException</span> <span class="o">?</span> <span class="n">empty</span><span class="o">()</span> <span class="o">:</span> <span class="n">error</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">compose</span><span class="o">(</span><span class="n">common</span><span class="o">(</span><span class="n">retryFunction</span><span class="o">()))</span>         <span class="c1">// common code</span>
        <span class="o">.</span><span class="na">toCompletable</span><span class="o">()</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="4-updatek-key-functionv-v-update">4. update(K key, Function&lt;V, V&gt; update)</h3>
<p>Flow:</p>
<ol>
  <li>fetch document</li>
  <li>convert document to value</li>
  <li>apply a function to value</li>
  <li>save new value</li>
  <li>repeat from 1 if CAS mismatches</li>
</ol>

<p>In order to retry something, we need a function, which will produce new value.
This function would be called after every fail, to produce new value, based on existing value.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">update</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">V</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">updateFunction</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">just</span><span class="o">(</span><span class="n">converter</span><span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">key</span><span class="o">))</span>
            <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">bucket:</span><span class="o">:</span><span class="n">get</span><span class="o">)</span>
            <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">doc</span> <span class="o">-&gt;</span> <span class="n">just</span><span class="o">(</span><span class="n">converter</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">doc</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">updateFunction:</span><span class="o">:</span><span class="n">apply</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">value</span> <span class="o">-&gt;</span> <span class="n">converter</span><span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">doc</span><span class="o">.</span><span class="na">cas</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">bucket:</span><span class="o">:</span><span class="n">replace</span><span class="o">)</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">compose</span><span class="o">(</span><span class="n">common</span><span class="o">(</span><span class="n">casRetryFunction</span><span class="o">()));</span> <span class="c1">// common code</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Retry Function to recover from CAS mismatch looks like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="kd">private</span> <span class="n">RetryWhenFunction</span> <span class="nf">casRetryFunction</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">anyOf</span><span class="o">(</span>
            <span class="n">CASMismatchException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">DocumentAlreadyExistsException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">DocumentDoesNotExistException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">TemporaryFailureException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
            <span class="n">DurabilityException</span><span class="o">.</span><span class="na">class</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">maxRetry</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="5-cask-key-functionoptionalv-v-update">5. cas(K key, Function&lt;Optional&lt;V&gt;, V&gt; update)</h3>
<p>Flow:</p>
<ol>
  <li>fetch document, if it exists continue with <strong>update flow</strong></li>
  <li>if document not found, use <strong>insert flow</strong></li>
  <li>repeat from 1 if CAS mismatches, or Document was inserted during update by someone else, or Document was removed during insert by someone else</li>
</ol>

<p>This method will use the same update function.
But now, input to the function would be <strong>Optional</strong>.
In this way, the caller would now:</p>
<ul>
  <li>if value is present, update is performed.</li>
  <li>if value is absent, insert is performed.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="kd">public</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="nf">cas</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">updateFunction</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">update</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">updateFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">v</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">switchIfEmpty</span><span class="o">(</span><span class="n">insert</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">updateFunction</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">())))</span>
        <span class="o">.</span><span class="na">retryWhen</span><span class="o">(</span><span class="n">casRetryFunction</span><span class="o">());</span>           <span class="c1">// retry in case of failure</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<hr />

<h2 id="conclusion">Conclusion</h2>
<p>Couchbase is great choice for Game Dev, because it provides incredible performance and Key-Value model.
Under high-load, applications need to perform consistent modifications at persistence layer.
Pessimistic locking does not scale well, because it locks entry for modification. On the other hand, optimistic locking does not lock anything, thus has much better performance.
Couchbase provides optimistic locking capabilities, but they are oftenly forgotten.
We have implemented a Repository pattern for Couchbase layer, which provides CRUD operations + concurrent, safe updates via functions.</p>
</main>
        <div class="share-page padded">
            Share this on &rarr;
            <a href="https://twitter.com/intent/tweet?text=Reactive Repositories with Couchbase&url=http://alexsderkach.io/reactive-repositories-couchbase/&via=alexsderkach&related=alexsderkach" rel="nofollow" target="_blank" title="Share on Twitter">Twitter</a>
            <a href="https://facebook.com/sharer.php?u=http://alexsderkach.io/reactive-repositories-couchbase/" rel="nofollow" target="_blank" title="Share on Facebook">Facebook</a>
            <a href="https://plus.google.com/share?url=http://alexsderkach.io/reactive-repositories-couchbase/" rel="nofollow" target="_blank" title="Share on Google+">Google+</a>
        </div>
    </article>

    <div class="padded">
        

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://alexsderkach.io/reactive-repositories-couchbase/';
      this.page.identifier = 'http://alexsderkach.io/reactive-repositories-couchbase/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://alexsderkach.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


        <script id="dsq-count-scr" src="//alexsderkach.disqus.com/count.js" async></script>
    </div>
</div>
    <footer class="padded">
    <p>
        This blog is built with <a href="http://jekyllrb.com/">Jekyll</a> and hosted on <a href="https://pages.github.com/">GitHub Pages</a>
        <br>
        <a href="https://github.com/alexsderkach" class="github"><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a>
    </p>
</footer>
</body>
</html>